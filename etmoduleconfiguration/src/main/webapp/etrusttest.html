var etrustServices = new EtrustServicesEnum();

function EtrustServicesEnum() {
    this.PRDUCT_REVIEW = "et_presale_preview";
}
//var etrust = new Etrust({serviceName:etrustServices.PRDUCT_REVIEW,productId:3,showReviewElement:"hola", displayData:true});
//callBackReviews, serviceName, createReviewElement, showReviewElement, displayData
function Etrust(options){
    
    if(!options || !options["serviceName"])
        throw "ETRUST EXCEPTION -> No service invoked";

var Utils = new EtrustUtilities()
etHost = "http://localhost:8080/etmoduleconfiguration/",
etUser = "prestashop",
serviceName = options["serviceName"]
etPass = "prestashop";
    
this.modules={};

function ProductReview(){ 
        
    if (!options["productId"])
        throw "ETRUST EXCEPTION -> Product id is mandatory for using this service ::: "+etrustServices.PRDUCT_REVIEW;
    this.enable = new EnableProductReview();
}
    
if(options["serviceName"] === etrustServices.PRDUCT_REVIEW){
    this.modules.productReviewModules = new ProductReview();
}

    //Presale - productreview - save new
    if(options["createReviewElement"])
        this.psRvNew = this.modules.productReviewModules.enable.loadModules.createProductReview.saveProductReview;

    
function EnableProductReview(){
        
        var getPresaleMetadata = "etapi/presale/getFunctionalities",
        getProductReviewUrl="etapi/presale/productreview/getReview",
        rateComment="/etapi/presale/productreview/rate",
        productRevMetaData, metadataLoaded=false;
    
        this.loadModules = new loadProductReviewModules();
            
        getModuleMetaData(etrustServices.PRDUCT_REVIEW,this);
    
        function getModuleMetaData(service,thiz){
            
            var self = thiz;
                $.ajax({
                    type:"GET",
                    url:  etHost + getPresaleMetadata,
                    data: {"serviceName":service},
                    success: function(data){
                        if(data.response && data.response.length > 0)
                        productRevMetaData = data.response[0];
                        thiz.loadModules = new loadProductReviewModules();
                        metadataLoaded = true;
                    },
                    fail: function(data){
                        console.log("Error in ETRUST" + data);
                    }
                });
            }
    
        function createProductReview(element){
            var addReviewURL = "etapi/presale/productreview/add";     
            this.saveProductReview = function saveProductReview(){
                var review = {productId:options["productId"], customerId:options["customerId"], saleId:options["saleId"]};

                $.each(productRevMetaData.functionalities,function(i,item){
                    var value = getElementValue(item,"create");
                    if(value && value.length > 0)
                        review[item.visualId] = value;
                });

                $.ajax({
                        type: "POST",
                        url:  etHost +  addReviewURL,
                        dataType : "json",
                        data : JSON.stringify(review),
                        contentType: "application/json",
                        success: function(data){
                            alert("Comentario guardado con éxito");
                        }
                    });
            }
                 
            if(!productRevMetaData || productRevMetaData.functionalities.length == 0) return;
              
            function openForm(){
                return "<form id='form"+productRevMetaData.serviceName+"_create' style=width:85%;margin-left:5%;>";
            }

            function addButtonForm(id){

                var input = "<div class = 'row'>"; 
                input += "<button type='button' class='btn btn-default button' onclick='etrust.psRvNew()'>Guardar</button>\n";
                input += "</div>";

                return input;

            }
            
            function closeForm(){
                return "</form>"
            }
            
            function getElementValue(item,prefix){

                switch (item.htmlElement){

                        case "forminputtext":
                            return $("#"+prefix+item.visualId).val();
                            break;
                        case "forminputarea":
                            return $("#"+prefix+item.visualId).val();
                        break;
                        case "formstars":
                            return $("#"+prefix+item.visualId).val();
                        break;
                        case "formcheck":
                            return $("#"+prefix+item.visualId).attr("checked")?true:false;
                        break;
                        case "formdate":
                            return $("#"+prefix+item.visualId).val();
                        break;
                    }

            }
             

            var ele = $("#"+element);
            ele.html("");
            
            var htmlData = openForm(productRevMetaData.serviceName);
            
            $.each(productRevMetaData.functionalities,function(i,item){
                if(item.status === "active")
                switch (item.htmlElement){
                    
                    case "forminputtext":
                        htmlData += Utils.Visual.addFormInputText(ele,item,"create");
                        break;
                    case "forminputarea":
                        htmlData += Utils.Visual.addFormArea(ele,item,"create");
                    break;
                    case "formstars":
                        htmlData += Utils.Visual.addFormStars(ele,item,"create");
                    break;
                    case "formcheck":
                        htmlData += Utils.Visual.addFormCheck(ele,item,"create");
                    break;
                    case "formdate":
                        htmlData += Utils.Visual.addFormDate(ele,item,"create");
                    break;
                }

            });
            htmlData += addButtonForm(productRevMetaData.serviceName);
            htmlData += closeForm();
            ele.append(htmlData);
        }
    
        function showProductReview(){
        
            if(!productRevMetaData || !productRevMetaData.functionalities)
                    return;
            
            this.productReviews = function getProductReview(){
                var url =  etHost +  getProductReviewUrl;
                $.ajax({
                        type:"GET",
                        url:  etHost +  getProductReviewUrl +"?productId="+options["productId"],
                        contentType: "application/json",
                        success: function(data){
                            if(data.response)
                            if(options["displayData"])
                                displayReviews(data.response);
                            else
                                options["callBackReviews"](data);
                        },
                        fail: function(data){
                            console.log("Error in ETRUST" + data);
                        }
                    });
            }
            
            function getFuncByName(name){
                
                var found;
                $.each(productRevMetaData.functionalities,function(i,item){
                    
                    if (name === item.visualId){
                        found = item;
                        return;
                    }
                
                });
                
                return found;
            }
            
            function displayReviews(reviews){
                var htmlData = Utils.Visual.openRowDiv();
                
                var ele = $("#"+options["showReviewElement"]);
                
                $.each(reviews,function(i,item){
                    htmlData += Utils.Visual.openColDiv(12);
                    for(var prop in item){
                        var data = item[prop];
                        var func = getFuncByName(prop);
                        if(func && func.status ==="active" && data && data!="" && data!="null"){
                            
                            htmlData += Utils.Visual.openColDiv(6);
                            htmlData += Utils.Visual.boldText(func.name);
                            htmlData += Utils.Visual.closeDiv();
                            switch(func.htmlElement){
                                case "forminputtext":
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.paragr(data);
                                    htmlData += Utils.Visual.closeDiv();
                                    break;
                                case "forminputarea":
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.paragr(data);
                                    htmlData += Utils.Visual.closeDiv();
                                break;
                                case "formstars":
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.closeDiv();
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.addFormStars(ele,func,"create",{hideLabel:true});
                                    htmlData += Utils.Visual.closeDiv();
                                    $("input[name="+func.visualId+"][value=" + data + "]").prop('checked', true);
                                break;
                                case "formcheck":
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.paragr((data =="on"?"Sí":"No"));
                                    htmlData += Utils.Visual.closeDiv();
                                    $("input[name="+func.visualId+"][value=" + data + "]").prop('checked', true);
                                break;
                                case "formdate":
                                    htmlData += Utils.Visual.openColDiv(6);
                                    htmlData += Utils.Visual.addFormStars(ele,func,"create");
                                    htmlData += Utils.Visual.closeDiv();
                                    $("input[name="+func.visualId+"][value=" + data + "]").prop('checked', true);
                                break;
                            }
                        }
                    }
                    htmlData += Utils.Visual.addLink("Ver imágenes y videos de esta reseña",item.reviewId);
                    htmlData += Utils.Visual.lnBreak();
                    htmlData += Utils.Visual.closeDiv();
                    
                    
                    
                });
                
                Utils.Visual.closeDiv();
                ele.append(htmlData);
            }
            
            this.productReviews();
            
            
        }
        
        function loadProductReviewModules(){
            if(options["createReviewElement"]){
               this.createProductReview  = new createProductReview(options["createReviewElement"]);
            }
            if(options["showReviewElement"]){
               this.showProductReviews  = new showProductReview(options["createReviewElement"]);
            }
        }
}

        
function EtrustUtilities(){
    
    function VisualObjects(){
        this.addFormArea = function addFormArea(element,item,prefix){

            var input = "<div class = 'form-group'>\n";
            input += "<label for='"+prefix+item.visualId+"'>"+item.name+"</label>\n";
            input += "<textarea name = '"+prefix+item.visualId+"' class='form-control' rows='3' id='"+prefix+item.visualId+"'></textarea>\n";
            input +='</div>\n';

            return input;
        }

        this.addFormStars = function addFormStars(element,item,prefix,labelopt){

            var input = "<div class = 'form-group'>\n";
            if(!labelopt || !labelopt["hideLabel"])
            input += "<label for='"+prefix+item.visualId+"'>"+item.name+"</label>\n";

                input +='<div class="star_content">';

                    input +='<input class="star not_uniform" style="margin-right: 2px; height:inherit; width:inherit;" type="radio" name = '+prefix+item.visualId+' value="1" />\n';
                    input +='<input class="star not_uniform" style="margin-right: 2px; height:inherit; width:inherit;" type="radio" name = '+prefix+item.visualId+' value="2" />\n';
                    input +='<input class="star not_uniform" style="margin-right: 2px; height:inherit; width:inherit;" type="radio" name = '+prefix+item.visualId+' value="3" />\n';
                    input +='<input class="star not_uniform" style="margin-right: 2px; height:inherit; width:inherit;" type="radio" name = '+prefix+item.visualId+' value="4" />\n';
                    input +='<input class="star not_uniform" style="margin-right: 2px; height:inherit; width:inherit;" type="radio" name = '+prefix+item.visualId+' value="5" />\n';
                    input +='<div class="clearfix"></div>';
                input +='</div>\n';
            input +='</div>\n';


            return input;
        }

        this.addFormCheck = function addFormCheck(element,item,prefix){

            var input = "<div class = 'checkbox'>\n";
            input += "<label>\n";
            input += "<input name='"+prefix+item.visualId+"'type='checkbox' id="+prefix+item.visualId+" style='width: inherit;height: inherit;'>\n";
            input += item.name;
            input += "</label>\n";
            input +='</div>\n';

            return input;
        }

        this.addFormDate = function addFormDate(element,item,prefix){

            var input = "<div class = 'form-group'>\n";
            input += "<label for='"+prefix+item.visualId+"'>"+item.name+"</label>\n";
            input += "<input name='"+prefix+item.visualId+"' type='date' class='form-control' id='"+prefix+item.visualId+"' placeholder="+item.name+">\n";
            input +='</div>\n';

            return input;
        }

        this.addFormInputText = function addFormInputText(element,item,prefix){

            var input = "<div class = 'form-group'>\n";
            input += "<label for='"+prefix+item.visualId+"'>"+item.name+"</label>\n";
            input += "<input name='"+prefix+item.visualId+"' type='text' class='form-control' id='"+prefix+item.visualId+"' placeholder="+item.name+">\n";
            input +='</div>';

            return input;
        }
        
        this.openRowDiv = function(){
            var input = "<div class = 'row'>\n";
            return input;
        }
        
        this.openColDiv = function (anchor){
        var input = "<div class = 'col-xs-"+anchor+"'>\n";
            return input;
        }
        
        this.closeDiv = function(){ 
            return "</div>\n";
        }
        
        this.lnBreak = function(){ 
            return "<hr>\n<br>\n";
        }
        
        this.boldText = function(text){ 
            return "<p><b>"+text+"</b></p>\n";
        }
        
        this.paragr = function(text){ 
            return "<p>"+text+"</p>\n";
        }
        
        this.addLink = function(text,link){
            return "<a href'#' style='color:blue;cursor:pointer' onclick="+'"alert('+"'videos reseña id:"+link+"'"+');">'+text+"</a>\n"
        }
    }
    
    this.Visual = new VisualObjects();
}
    
}